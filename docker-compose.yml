version: '3'
services:
  myapp:
    build:
      context: .
      dockerfile: Dockerfile
    image: myapp

  fastapi:
    image: myapp
    command: python main.py
    ports:
      - '8000:8000'
    depends_on:
      - scraper
      - redis
      - celery
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ./backend/main.py:/app/main.py

  scraper:
    image: myapp
    command: python scrap_main.py
    volumes:
      - ./backend/scrap_main.py:/app/scrap_main.py

  celery:
    image: myapp
    command: celery -A celery_tasks worker --loglevel INFO -P threads -c 4 --uid=celeryuser
    depends_on:
      - redis
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ./backend/celery_tasks.py:/app/celery_tasks.py

  redis:
    image: redis:latest
    privileged: true
